# ロボットシステム学2017第13回

上田 隆一

2017年12月13日@千葉工業大学

## 今日の内容

* ROSの続き
  * roslaunch
  * rosbridge

### roslaunch

* いちいちノードを手でたくさん立ち上げるのは面倒
* XMLに立ち上げに関する情報を置いて、ひとつのコマンドで立ち上げられる仕組み

```bash
$ cd ~/catkin_ws/src/mypkg/      #roscd mypkgでもよい
$ mkdir launch
$ cd launch
```

* `launch`ディレクトリの下で次のように記述
  * ファイル名は`mypkg.launch`としておきましょう

```mypkg.launch
<launch>
  <node pkg="mypkg" name="count" type="count.py" required="true" />
  <node pkg="mypkg" name="twice" type="twice.py" required="true" />
</launch>
```


* 実行

```bash
$ roslaunch mypkg mypkg.launch 
... logging to /home/ubuntu/.ros/log/2a1397ac-d0df-11e5-88c9-b827eb62a884/roslaunch-ubuntu-2217.log
Checking log directory for disk usage. This may take awhile.
Press Ctrl-C to interrupt
Done checking log file disk usage. Usage is <1GB.

started roslaunch server http://localhost:45489/

SUMMARY
========

PARAMETERS
 * /rosdistro: kinetic
 * /rosversion: 1.12.7

NODES
  /
    count (mypkg/count.py)
    twice (mypkg/twice.py)

ROS_MASTER_URI=http://localhost:11311

core service [/rosout] found
process[count-1]: started with pid [2235]
process[twice-2]: started with pid [2236]
（立ち上がりっぱなしになる）
```

* 通信を一通り試したら切りましょう。

## rosbridge

* ROSからウェブにデータを飛ばしてみましょう。

### HTMLファイルの準備

* scriptsの中にindex.htmlを準備

```index.html
test
```


### ウェブサーバの準備

* Pythonの簡易ウェブサーバを使います

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
import rospy, os
import SimpleHTTPServer

def kill():
    os.system("kill -KILL " + str(os.getpid())) #強制シャットダウン

os.chdir(os.path.dirname(__file__))  #scriptsディレクトリが見えるように
rospy.init_node("webserver")         #rosのノード登録
rospy.on_shutdown(kill)              #kill関数の登録
SimpleHTTPServer.test()              #サーバ立ち上げ
```

### launchファイルへの登録

* mypkg.launchにwebserverノードを登録します

```mypkg.launch
<launch>
  <node pkg="mypkg" name="count" type="count.py" required="true" />
  <node pkg="mypkg" name="twice" type="twice.py" required="true" />
  <node pkg="mypkg" name="webserver" type="webserver.py" args="8000" required="true" />  <-これを追加
</launch>
```

### 立ち上げ

```bash
$ roslaunch mypkg mypkg.launch 
```

この後、手元のPCのブラウザで`http://ラズパイのIPアドレス:8000`を閲覧

<img style="width:50%" src="./web.png" />
