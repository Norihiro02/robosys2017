# ロボットシステム学2017第12回

上田 隆一

2017年12月6日@千葉工業大学

## 今日の内容

* ROS

## ROS: robot operating system

* ロボットのソフトウェアコンポーネントを作って
  動作させるためのフレームワーク/ミドルウェア
  * OSでは無い
* 発祥: 2000年代後半、Willow Garage社
* BSDライセンス
* Linux（Ubuntu）上での動作がデフォルト
* サイト
  * 公式ページ: http://www.ros.org/
  * マニュアル等: http://wiki.ros.org/ja


## どんなものか

* 本体: プロセス間通信をつかさどる
  * プロセス同士をpublish-subscribeモデルやサービスでつなぐ
  * XML-RPC等を利用
  * 通信するデータに型
* 周辺
  * ビルドシステム、パッケージ管理、テストツール、・・・


<span style="color:red">と書いてもよくわからんのでこちらで動かしてみます</span>



## デモ

* カメラの画像をブラウザから見る
* 手順
  * 1: ROS・ワークスペースのセットアップ（来週）
  * 2: 必要なパッケージのダウンロードとビルド
    ```bash
    $ sudo apt install ros-kinetic-cv-camera
    $ sudo apt install ros-kinetic-cv-bridge
    $ cd ~/catkin_ws/src
    $ git clone git@github.com:RobotWebTools/mjpeg_server.git
    $ cd ..
    $ catkin_make
    ```
  * 3: 見る
    ```
    $ roscore &
    $ rosrun cv_camera cv_camera_node &
    $ rosrun mjpeg_server mjpeg_server
    ブラウザでhttp://<IPアドレス>:8080/stream?topic=/cv_camera/image_raw
    ```

## さらに便利に使う

* ROS化されているキラーコンテンツ
  * slam_gmapping, ナビゲーションメタパッケージ
    * 地図生成（次のページにデモ）、位置推定、経路生成
  * MoveIt!
    * 腕の動作計画 腕先の位置を入力→関節角を計算（逆運動学）
  * その他、様々なハード・ソフトがROS化

## ROSを使ったSLAMの様子

* https://www.youtube.com/embed/b2kYQ11PUSI"
  * ポイント: SLAMのコードは書いてない
    * aptでSLAM（Gmapping）のコードが入る
    * デッドレコニングのコードをちょっと書いただけ

## ROSを使ったナビゲーションの様子

* https://youtu.be/RpPcmyXOcr4
  * SLAMをした後のナビゲーション
    * 自己位置推定、障害物回避、...
    * 足回りもROSのパッケージ化

## ROSのインストール

* Ubuntu 16.04にインストールして使用
  * 次のリポジトリにインストーラ
    * https://github.com/ryuichiueda/ros_setup_scripts_Ubuntu16.04_server
      * 中にあるシェルスクリプトをstep0.bash, step1.bash, locale.ja.bashと実行すればOK
* 講義ではインストール済みのイメージファイルを利用
  * 参考: [昨年の講義資料](https://lab.ueda.tech/?presenpress=%E3%83%AD%E3%83%9C%E3%83%83%E3%83%88%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%AD%A62016%E7%AC%AC12%E5%9B%9E#/15)

## 動作確認

* `roscore`
  * ROSの基盤となるプログラムが立ち上がる
  * Ctrl+cで出る

```bash
$ roscore
（略）
started roslaunch server http://localhost:39310/
ros_comm version 1.12.6

SUMMARY
========

PARAMETERS
* /rosdistro: kinetic
* /rosversion: 1.12.6

NODES

auto-starting new master
process[master]: started with pid [1439]
ROS_MASTER_URI=http://localhost:11311/

setting /run_id to b749a100-d0dc-11e5-a506-b827eb17cb96
process[rosout-1]: started with pid [1452]
started core service [/rosout]
```

## ROSのノード

* プログラムのプロセス一つ一つが「ノード」と呼ばれる
* ノードの例
  * cv_cameraとmjpeg_serverを立ち上げる（roscoreは立ち上げておく）
```bash
$ rosrun cv_camera cv_camera_node 
$ rosrun mjpeg_server mjpeg_server 
```
  * ノードの確認
```bash
$ rosnode list
/cv_camera
/mjpeg_server
/rosout
```
* ディレクトリのように管理されている

## トピック・メッセージ

* 今度はrostopic listと打ってみる
  * データをやり取りする口（トピック）が表示される

  ```bash
  $ rostopic list
  /cv_camera/camera_info
  /cv_camera/image_raw
  /rosout
  /rosout_agg
  ```

  * トピックからデータを取り出す（先ほどもやりました）

    ```bash
    $ rostopic echo /cv_camera/image_raw
    ```

    * このデータは「メッセージ」と呼ばれる

